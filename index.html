<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Monitoring Ruangan Kantor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        /* Dark mode styles */
        .dark {
            background-color: #1f2937;
            color: #f9fafb;
        }
        
        .dark.bg-gray-50 {
            background-color: #1f2937 !important;
        }
        
        .dark .bg-white {
            background-color: #374151;
            color: #f9fafb;
        }
        
        .dark .text-gray-800 {
            color: #f9fafb;
        }
        
        .dark .text-gray-600 {
            color: #d1d5db;
        }
        
        .dark .text-gray-700 {
            color: #e5e7eb;
        }
        
        .dark .text-gray-500 {
            color: #9ca3af;
        }
        
        .dark .border-gray-300 {
            border-color: #4b5563;
        }
        
        .dark .border-gray-200 {
            border-color: #4b5563;
        }
        
        .dark .bg-gray-50 {
            background-color: #374151;
        }
        
        .dark .hover\\:bg-gray-50:hover {
            background-color: #4b5563;
        }
        
        .dark input, .dark select {
            background-color: #4b5563;
            color: #f9fafb;
            border-color: #6b7280;
        }
        
        .dark input:focus, .dark select:focus {
            border-color: #3b82f6;
            background-color: #4b5563;
        }
        
        .dark .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .detailed-chart {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .detailed-chart-large {
            position: relative;
            height: 500px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold">Sistem Monitoring Ruangan</h1>
                <div class="flex items-center gap-4">
                    <button onclick="toggleDarkMode()" id="darkModeToggle" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-2 rounded-lg transition duration-300">
                        üåô
                    </button>
                    <nav id="breadcrumb" class="text-sm opacity-90"></nav>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Halaman Utama -->
        <div id="homePage" class="page">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Dashboard Monitoring Ruangan</h2>
                <p class="text-gray-600">Pilih ruangan untuk melihat data monitoring atau tambah ruangan baru</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="roomGrid">
                <!-- Room cards akan ditambahkan di sini -->
            </div>

            <div class="text-center mb-8">
                <button onclick="showAddRoomForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition duration-300 shadow-lg mr-4">
                    + Tambah Ruangan Baru
                </button>
                <button onclick="showSupabaseConfig()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold transition duration-300 shadow-lg">
                    ‚öôÔ∏è Konfigurasi Supabase
                </button>
            </div>

            <!-- Panel Konfigurasi Supabase -->
            <div id="supabaseConfigPanel" class="hidden mt-8 max-w-4xl mx-auto">
                <div class="bg-white p-6 rounded-lg card-shadow">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800 text-center">üóÑÔ∏è Konfigurasi Database Supabase</h3>
                    
                    <!-- Status Koneksi -->
                    <div id="connectionStatus" class="mb-6 p-4 rounded-lg bg-gray-100">
                        <div class="flex items-center">
                            <span id="statusIcon" class="text-2xl mr-3">‚ö™</span>
                            <span id="statusText" class="font-semibold">Belum terkonfigurasi</span>
                        </div>
                    </div>

                    <!-- Form Konfigurasi -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Supabase URL</label>
                            <input type="url" id="supabaseUrl" placeholder="https://your-project.supabase.co" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">URL project Supabase Anda</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key (anon/public)</label>
                            <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">API Key public dari Supabase</p>
                        </div>
                    </div>

                    <!-- Tombol Aksi -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                        <button onclick="testConnection()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-semibold transition duration-300">
                            üîç Test Koneksi
                        </button>
                        <button onclick="saveSupabaseConfig()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-semibold transition duration-300">
                            üíæ Simpan Config
                        </button>
                        <button onclick="syncAllData()" class="bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg font-semibold transition duration-300">
                            üîÑ Sinkronisasi
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                        <button onclick="loadFromSupabase()" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg font-semibold transition duration-300">
                            üì• Load Data dari Cloud
                        </button>
                        <button onclick="clearSupabaseConfig()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-semibold transition duration-300">
                            üóëÔ∏è Hapus Konfigurasi
                        </button>
                    </div>

                    <!-- Panduan Setup -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-blue-800 mb-2">üìã Panduan Setup Supabase (Gratis Selamanya)</h4>
                        <ol class="text-sm text-blue-700 space-y-1 list-decimal list-inside">
                            <li>Daftar gratis di <a href="https://supabase.com" target="_blank" class="underline">supabase.com</a></li>
                            <li>Buat project baru (pilih region terdekat)</li>
                            <li>Di dashboard, buka Settings ‚Üí API</li>
                            <li>Copy "Project URL" dan "anon public" key</li>
                            <li>Paste di form di atas, lalu klik "Test Koneksi"</li>
                            <li>Jika berhasil, klik "Simpan Config"</li>
                            <li>Klik "Lihat Script SQL Manual" untuk setup database</li>
                            <li>Copy dan jalankan script SQL di SQL Editor Supabase</li>
                            <li>Terakhir klik "Sinkronisasi" untuk upload data lokal</li>
                        </ol>
                        <div class="mt-3 p-3 bg-blue-100 rounded">
                            <p class="text-blue-800 font-medium mb-2">üìù Setup Database dengan SQL Manual</p>
                            <button onclick="showManualSQL()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition duration-300">
                                üìù Lihat Script SQL Manual
                            </button>
                        </div>
                    </div>



                    <!-- Log Aktivitas -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">üìù Log Aktivitas</h4>
                        <div id="activityLog" class="text-sm text-gray-600 max-h-32 overflow-y-auto">
                            <p>Belum ada aktivitas...</p>
                        </div>
                    </div>

                    <div class="text-center mt-6">
                        <button onclick="hideSupabaseConfig()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold transition duration-300">
                            Tutup Panel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal PDF Configuration -->
            <div id="pdfConfigModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">‚öôÔ∏è Konfigurasi Header PDF</h3>
                        <button onclick="hidePDFConfigModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">√ó</button>
                    </div>
                    
                    <form id="pdfConfigForm" class="space-y-4">
                        <!-- Nama Rumah Sakit -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Rumah Sakit *</label>
                            <input type="text" id="hospitalName" placeholder="RUMAH SAKIT UMUM DAERAH" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>

                        <!-- Alamat -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Alamat (Opsional)</label>
                            <input type="text" id="hospitalAddress" placeholder="Jl. Kesehatan No. 123, Kota Sehat" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>

                        <!-- Kontak -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Telepon (Opsional)</label>
                                <input type="tel" id="hospitalPhone" placeholder="(021) 123-4567" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email (Opsional)</label>
                                <input type="email" id="hospitalEmail" placeholder="info@rumahsakit.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                        </div>

                        <!-- Logo URLs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">URL Logo Kiri (Opsional)</label>
                                <input type="url" id="logo1Url" placeholder="https://example.com/logo1.png" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Logo akan ditampilkan di kiri atas. Gunakan URL gambar yang dapat diakses publik (PNG/JPG)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">URL Logo Kanan (Opsional)</label>
                                <input type="url" id="logo2Url" placeholder="https://example.com/logo2.png" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Logo akan ditampilkan di kanan atas. Gunakan URL gambar yang dapat diakses publik (PNG/JPG)</p>
                            </div>
                        </div>

                        <!-- Logo Troubleshooting Info -->
                        <div class="bg-amber-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-amber-800 mb-2">üí° Tips untuk Logo:</h4>
                            <ul class="text-sm text-amber-700 space-y-1 list-disc list-inside">
                                <li>Gunakan URL gambar yang dapat diakses publik (tidak memerlukan login)</li>
                                <li>Format yang didukung: PNG, JPG, JPEG</li>
                                <li>Ukuran optimal: 200x200 pixel atau lebih kecil</li>
                                <li>Contoh layanan hosting gambar gratis: <a href="https://imgur.com" target="_blank" class="underline">Imgur</a>, <a href="https://postimg.cc" target="_blank" class="underline">PostImg</a></li>
                                <li>Jika logo tidak muncul, periksa URL dapat dibuka di browser</li>
                            </ul>
                        </div>

                        <!-- Preview Info -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">üìã Preview Layout PDF:</h4>
                            <div class="text-sm text-blue-700 space-y-1">
                                <p>‚Ä¢ Header: Logo Kiri | Nama RS + Alamat + Kontak | Logo Kanan</p>
                                <p>‚Ä¢ Garis pemisah horizontal</p>
                                <p>‚Ä¢ Judul: "LEMBAR PEMANTAUAN [JENIS DATA]" (tengah)</p>
                                <p>‚Ä¢ Info: "Ruangan: [Nama]" dan "Periode: [Bulan Tahun]" (kiri)</p>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="flex gap-3 pt-4">
                            <button type="button" onclick="savePDFConfigAndExport()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-semibold transition duration-300">
                                üíæ Simpan & Export PDF
                            </button>
                            <button type="button" onclick="hidePDFConfigModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold transition duration-300">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal SQL Manual -->
            <div id="sqlModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üìù Script SQL Manual untuk Supabase</h3>
                        <button onclick="hideManualSQL()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">√ó</button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Instruksi -->
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-yellow-800 mb-2">üìã Cara Menggunakan:</h4>
                            <ol class="text-sm text-yellow-700 space-y-1 list-decimal list-inside">
                                <li>Login ke dashboard Supabase Anda</li>
                                <li>Buka menu <strong>SQL Editor</strong> di sidebar kiri</li>
                                <li>Klik <strong>"New Query"</strong></li>
                                <li>Copy dan paste script SQL di bawah ini</li>
                                <li>Klik <strong>"Run"</strong> untuk menjalankan script</li>
                                <li>Kembali ke aplikasi ini dan lakukan "Test Koneksi"</li>
                            </ol>
                        </div>

                        <!-- Script 1: Tabel Rooms -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-800">1Ô∏è‚É£ Tabel Ruangan (rooms)</h4>
                                <button onclick="copyToClipboard('sql1')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition duration-300">
                                    üìã Copy
                                </button>
                            </div>
                            <pre id="sql1" class="bg-gray-800 text-green-400 p-4 rounded text-sm overflow-x-auto"><code>-- Tabel untuk menyimpan data ruangan
CREATE TABLE IF NOT EXISTS rooms (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    color TEXT DEFAULT 'blue',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Index untuk performa
CREATE INDEX IF NOT EXISTS idx_rooms_name ON rooms(name);

-- Trigger untuk update timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_rooms_updated_at 
    BEFORE UPDATE ON rooms 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();</code></pre>
                        </div>

                        <!-- Script 2: Tabel Monitoring Data -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-800">2Ô∏è‚É£ Tabel Data Monitoring (monitoring_data)</h4>
                                <button onclick="copyToClipboard('sql2')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition duration-300">
                                    üìã Copy
                                </button>
                            </div>
                            <pre id="sql2" class="bg-gray-800 text-green-400 p-4 rounded text-sm overflow-x-auto"><code>-- Tabel untuk menyimpan data monitoring
CREATE TABLE IF NOT EXISTS monitoring_data (
    id TEXT PRIMARY KEY,
    room_id TEXT NOT NULL REFERENCES rooms(id) ON DELETE CASCADE,
    data_type TEXT NOT NULL CHECK (data_type IN ('temperature', 'humidity', 'fridge')),
    date DATE NOT NULL,
    shift TEXT NOT NULL CHECK (shift IN ('pagi', 'malam')),
    value DECIMAL(5,2) NOT NULL,
    operator TEXT NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- Constraint untuk memastikan tidak ada duplikasi data per ruangan/tanggal/shift/tipe
    UNIQUE(room_id, data_type, date, shift)
);

-- Index untuk performa query
CREATE INDEX IF NOT EXISTS idx_monitoring_room_id ON monitoring_data(room_id);
CREATE INDEX IF NOT EXISTS idx_monitoring_date ON monitoring_data(date);
CREATE INDEX IF NOT EXISTS idx_monitoring_type ON monitoring_data(data_type);
CREATE INDEX IF NOT EXISTS idx_monitoring_composite ON monitoring_data(room_id, data_type, date);</code></pre>
                        </div>

                        <!-- Script 3: RLS Policies -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-800">3Ô∏è‚É£ Row Level Security (RLS) - Opsional</h4>
                                <button onclick="copyToClipboard('sql3')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition duration-300">
                                    üìã Copy
                                </button>
                            </div>
                            <pre id="sql3" class="bg-gray-800 text-green-400 p-4 rounded text-sm overflow-x-auto"><code>-- Aktifkan Row Level Security (RLS)
ALTER TABLE rooms ENABLE ROW LEVEL SECURITY;
ALTER TABLE monitoring_data ENABLE ROW LEVEL SECURITY;

-- Policy untuk tabel rooms - izinkan semua operasi untuk authenticated users
CREATE POLICY "Allow all operations for authenticated users on rooms" 
ON rooms FOR ALL 
TO authenticated 
USING (true) 
WITH CHECK (true);

-- Policy untuk tabel monitoring_data - izinkan semua operasi untuk authenticated users
CREATE POLICY "Allow all operations for authenticated users on monitoring_data" 
ON monitoring_data FOR ALL 
TO authenticated 
USING (true) 
WITH CHECK (true);

-- Policy untuk anonymous users (jika diperlukan)
CREATE POLICY "Allow all operations for anonymous users on rooms" 
ON rooms FOR ALL 
TO anon 
USING (true) 
WITH CHECK (true);

CREATE POLICY "Allow all operations for anonymous users on monitoring_data" 
ON monitoring_data FOR ALL 
TO anon 
USING (true) 
WITH CHECK (true);</code></pre>
                        </div>

                        <!-- Script 4: Sample Data -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-800">4Ô∏è‚É£ Data Contoh (Opsional)</h4>
                                <button onclick="copyToClipboard('sql4')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition duration-300">
                                    üìã Copy
                                </button>
                            </div>
                            <pre id="sql4" class="bg-gray-800 text-green-400 p-4 rounded text-sm overflow-x-auto"><code>-- Insert contoh ruangan
INSERT INTO rooms (id, name, color) VALUES 
('room_001', 'Ruang ICU', 'blue'),
('room_002', 'Ruang Operasi 1', 'green'),
('room_003', 'Ruang Farmasi', 'purple')
ON CONFLICT (id) DO NOTHING;

-- Insert contoh data monitoring
INSERT INTO monitoring_data (id, room_id, data_type, date, shift, value, operator) VALUES 
('data_001', 'room_001', 'temperature', '2024-01-15', 'pagi', 22.5, 'Perawat A'),
('data_002', 'room_001', 'temperature', '2024-01-15', 'malam', 23.0, 'Perawat B'),
('data_003', 'room_001', 'humidity', '2024-01-15', 'pagi', 55.0, 'Perawat A'),
('data_004', 'room_001', 'humidity', '2024-01-15', 'malam', 58.0, 'Perawat B'),
('data_005', 'room_001', 'fridge', '2024-01-15', 'pagi', 4.5, 'Perawat A'),
('data_006', 'room_001', 'fridge', '2024-01-15', 'malam', 5.0, 'Perawat B')
ON CONFLICT (room_id, data_type, date, shift) DO NOTHING;</code></pre>
                        </div>

                        <!-- Script 5: Useful Queries -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-800">5Ô∏è‚É£ Query Berguna untuk Analisis</h4>
                                <button onclick="copyToClipboard('sql5')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition duration-300">
                                    üìã Copy
                                </button>
                            </div>
                            <pre id="sql5" class="bg-gray-800 text-green-400 p-4 rounded text-sm overflow-x-auto"><code>-- Query untuk melihat semua data dengan nama ruangan
SELECT 
    r.name as room_name,
    md.data_type,
    md.date,
    md.shift,
    md.value,
    md.operator,
    md.timestamp
FROM monitoring_data md
JOIN rooms r ON md.room_id = r.id
ORDER BY md.date DESC, r.name, md.data_type;

-- Query untuk statistik per ruangan
SELECT 
    r.name as room_name,
    md.data_type,
    COUNT(*) as total_records,
    AVG(md.value) as avg_value,
    MIN(md.value) as min_value,
    MAX(md.value) as max_value
FROM monitoring_data md
JOIN rooms r ON md.room_id = r.id
GROUP BY r.name, md.data_type
ORDER BY r.name, md.data_type;

-- Query untuk data bulan ini
SELECT 
    r.name as room_name,
    md.data_type,
    md.date,
    md.shift,
    md.value,
    md.operator
FROM monitoring_data md
JOIN rooms r ON md.room_id = r.id
WHERE md.date >= DATE_TRUNC('month', CURRENT_DATE)
ORDER BY md.date DESC, r.name;

-- Query untuk deteksi nilai abnormal (contoh untuk suhu ruangan)
SELECT 
    r.name as room_name,
    md.date,
    md.shift,
    md.value,
    md.operator,
    CASE 
        WHEN md.data_type = 'temperature' AND (md.value < 15 OR md.value > 25) THEN 'ABNORMAL'
        WHEN md.data_type = 'humidity' AND (md.value < 40 OR md.value > 60) THEN 'ABNORMAL'
        WHEN md.data_type = 'fridge' AND (md.value < 2 OR md.value > 8) THEN 'ABNORMAL'
        ELSE 'NORMAL'
    END as status
FROM monitoring_data md
JOIN rooms r ON md.room_id = r.id
WHERE md.data_type = 'temperature'
ORDER BY md.date DESC;</code></pre>
                        </div>

                        <!-- Informasi Tambahan -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800 mb-2">‚úÖ Setelah Menjalankan Script:</h4>
                            <ul class="text-sm text-green-700 space-y-1 list-disc list-inside">
                                <li>Tabel <code>rooms</code> dan <code>monitoring_data</code> akan terbuat</li>
                                <li>Index otomatis ditambahkan untuk performa optimal</li>
                                <li>Row Level Security (RLS) diaktifkan untuk keamanan</li>
                                <li>Constraint dan validasi data sudah terpasang</li>
                                <li>Siap untuk sinkronisasi dengan aplikasi ini</li>
                            </ul>
                        </div>

                        <div class="text-center">
                            <button onclick="hideManualSQL()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold transition duration-300">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Tambah Ruangan -->
            <div id="addRoomForm" class="hidden mt-8 max-w-md mx-auto">
                <div class="bg-white p-6 rounded-lg card-shadow">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Tambah Ruangan Baru</h3>
                    <input type="text" id="roomNameInput" placeholder="Nama Ruangan" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    
                    <!-- Color Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Warna Kartu</label>
                        <div class="grid grid-cols-5 gap-2 mb-3" id="colorOptions">
                            <div class="color-option bg-gradient-to-br from-blue-400 to-blue-600 w-12 h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition duration-200" data-color="blue" onclick="selectColor('blue')"></div>
                            <div class="color-option bg-gradient-to-br from-green-400 to-green-600 w-12 h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition duration-200" data-color="green" onclick="selectColor('green')"></div>
                            <div class="color-option bg-gradient-to-br from-purple-400 to-purple-600 w-12 h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition duration-200" data-color="purple" onclick="selectColor('purple')"></div>
                            <div class="color-option bg-gradient-to-br from-pink-400 to-pink-600 w-12 h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition duration-200" data-color="pink" onclick="selectColor('pink')"></div>
                            <div class="color-option bg-gradient-to-br from-indigo-400 to-indigo-600 w-12 h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition duration-200" data-color="indigo" onclick="selectColor('indigo')"></div>
                            <div class="color-option bg-gradient-to-br from-teal-400 to-teal-600 w-12 h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition duration-200" data-color="teal" onclick="selectColor('teal')"></div>
                            <div class="color-option bg-gradient-to-br from-orange-400 to-orange-600 w-12 h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition duration-200" data-color="orange" onclick="selectColor('orange')"></div>
                            <div class="color-option bg-gradient-to-br from-red-400 to-red-600 w-12 h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition duration-200" data-color="red" onclick="selectColor('red')"></div>
                            <div class="color-option bg-gradient-to-br from-cyan-400 to-cyan-600 w-12 h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition duration-200" data-color="cyan" onclick="selectColor('cyan')"></div>
                            <div class="color-option bg-gradient-to-br from-emerald-400 to-emerald-600 w-12 h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition duration-200" data-color="emerald" onclick="selectColor('emerald')"></div>
                        </div>
                        <p class="text-xs text-gray-500">Klik warna untuk memilih</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="addRoom()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-semibold transition duration-300">
                            Tambah
                        </button>
                        <button onclick="hideAddRoomForm()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold transition duration-300">
                            Batal
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Halaman Summary Ruangan -->
        <div id="roomPage" class="page hidden">
            <div class="mb-6">
                <button onclick="showHomePage()" class="text-blue-600 hover:text-blue-800 font-semibold mb-4">
                    ‚Üê Kembali ke Dashboard
                </button>
                <h2 id="roomTitle" class="text-3xl font-bold text-gray-800 mb-2"></h2>
                <p class="text-gray-600">Klik pada diagram untuk mengedit data</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-lg card-shadow cursor-pointer hover:shadow-xl transition duration-300" onclick="showEditPage('temperature')">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Suhu Ruangan (¬∞C)</h3>
                    <div class="chart-container">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg card-shadow cursor-pointer hover:shadow-xl transition duration-300" onclick="showEditPage('humidity')">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Kelembaban (%)</h3>
                    <div class="chart-container">
                        <canvas id="humidityChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg card-shadow cursor-pointer hover:shadow-xl transition duration-300" onclick="showEditPage('fridge')">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Suhu Kulkas (¬∞C)</h3>
                    <div class="chart-container">
                        <canvas id="fridgeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Halaman Edit -->
        <div id="editPage" class="page hidden">
            <div class="mb-6">
                <button onclick="showRoomPageFromEdit()" class="text-blue-600 hover:text-blue-800 font-semibold mb-4">
                    ‚Üê Kembali ke Summary
                </button>
                <h2 id="editTitle" class="text-3xl font-bold text-gray-800 mb-2"></h2>
            </div>

            <!-- Form Input -->
            <div class="max-w-2xl mx-auto mb-8">
                <div class="bg-white p-6 rounded-lg card-shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Input Data</h3>
                    <form onsubmit="addDataPoint(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                            <input type="date" id="dateInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Shift</label>
                            <select id="shiftInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                <option value="">Pilih Shift</option>
                                <option value="pagi">Pagi</option>
                                <option value="malam">Malam</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" id="dataLabel">Nilai</label>
                            <input type="number" id="valueInput" step="0.1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pengisi</label>
                            <input type="text" id="operatorInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition duration-300">
                                Tambah Data
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Month Navigation -->
            <div class="max-w-2xl mx-auto mb-6">
                <div class="bg-white p-4 rounded-lg card-shadow">
                    <div class="flex items-center justify-between">
                        <button onclick="changeMonth(-1)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition duration-300">
                            ‚Üê Bulan Sebelumnya
                        </button>
                        <h3 id="currentMonthDisplay" class="text-lg font-semibold text-gray-800"></h3>
                        <button onclick="changeMonth(1)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition duration-300">
                            Bulan Berikutnya ‚Üí
                        </button>
                    </div>
                    <div class="mt-4 text-center flex gap-3 justify-center">
                        <button onclick="exportPDFDirect()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition duration-300 flex items-center gap-2">
                            üìÑ Export PDF
                        </button>
                        <div class="relative inline-block">
                            <button type="button" onclick="toggleConfigMenu()" id="configMenuButton" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition duration-300 flex items-center gap-2">
                                ‚öôÔ∏è Konfigurasi
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="configDropdown" class="hidden absolute top-full right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50 p-4">
                                <h4 class="font-semibold text-gray-800 mb-3">‚öôÔ∏è Konfigurasi Header PDF</h4>
                                <form id="quickConfigForm" class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Rumah Sakit *</label>
                                        <input type="text" id="quickHospitalName" placeholder="RUMAH SAKIT UMUM DAERAH" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Alamat</label>
                                        <input type="text" id="quickHospitalAddress" placeholder="Jl. Kesehatan No. 123" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Telepon</label>
                                            <input type="tel" id="quickHospitalPhone" placeholder="(021) 123-4567" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                            <input type="email" id="quickHospitalEmail" placeholder="info@rs.com" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Logo Kiri URL</label>
                                            <input type="url" id="quickLogo1Url" placeholder="https://..." class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Logo Kanan URL</label>
                                            <input type="url" id="quickLogo2Url" placeholder="https://..." class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                    </div>
                                    <div class="flex gap-2 pt-2">
                                        <button type="button" onclick="saveQuickConfig()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded text-sm font-medium transition duration-300">
                                            üíæ Simpan
                                        </button>
                                        <button type="button" onclick="hideConfigMenu()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded text-sm font-medium transition duration-300">
                                            Batal
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Diagram Detail -->
            <div class="mb-8">
                <div class="bg-white p-6 rounded-lg card-shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Diagram Detail</h3>
                    <div class="detailed-chart-large">
                        <canvas id="detailChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabel Data -->
            <div class="mt-8 bg-white p-6 rounded-lg card-shadow">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Data Tercatat</h3>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-left font-semibold text-gray-700">Tanggal</th>
                                <th class="px-4 py-2 text-left font-semibold text-gray-700">Shift</th>
                                <th class="px-4 py-2 text-left font-semibold text-gray-700">Nilai</th>
                                <th class="px-4 py-2 text-left font-semibold text-gray-700">Pengisi</th>
                                <th class="px-4 py-2 text-left font-semibold text-gray-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Data Storage
        let rooms = JSON.parse(localStorage.getItem('rooms')) || [];
        let currentRoom = null;
        let currentDataType = null;
        let charts = {};
        let currentViewMonth = new Date().getMonth();
        let currentViewYear = new Date().getFullYear();

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load dark mode preference
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark');
                document.getElementById('darkModeToggle').textContent = '‚òÄÔ∏è';
            }
            
            // Load Supabase config
            loadSupabaseConfig();
            
            showHomePage();
            renderRooms();
        });

        // Dark Mode Toggle
        function toggleDarkMode() {
            const body = document.body;
            const toggle = document.getElementById('darkModeToggle');
            
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                toggle.textContent = 'üåô';
                localStorage.setItem('darkMode', 'false');
            } else {
                body.classList.add('dark');
                toggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('darkMode', 'true');
            }
        }

        // Navigation Functions
        function showHomePage() {
            hideAllPages();
            document.getElementById('homePage').classList.remove('hidden');
            updateBreadcrumb(['Dashboard']);
            renderRooms();
        }

        function showRoomPage(roomId) {
            currentRoom = rooms.find(r => r.id === roomId);
            if (!currentRoom) return;

            hideAllPages();
            document.getElementById('roomPage').classList.remove('hidden');
            document.getElementById('roomTitle').textContent = currentRoom.name;
            updateBreadcrumb(['Dashboard', currentRoom.name]);
            
            setTimeout(() => {
                renderSummaryCharts();
            }, 100);
        }

        function showEditPage(dataType) {
            if (!currentRoom) return;
            
            currentDataType = dataType;
            hideAllPages();
            document.getElementById('editPage').classList.remove('hidden');
            
            const titles = {
                temperature: 'Suhu Ruangan (¬∞C)',
                humidity: 'Kelembaban (%)',
                fridge: 'Suhu Kulkas (¬∞C)'
            };
            
            const labels = {
                temperature: 'Suhu (¬∞C)',
                humidity: 'Kelembaban (%)',
                fridge: 'Suhu (¬∞C)'
            };

            document.getElementById('editTitle').textContent = titles[dataType];
            document.getElementById('dataLabel').textContent = labels[dataType];
            updateBreadcrumb(['Dashboard', currentRoom.name, titles[dataType]]);
            
            setTimeout(() => {
                // Reset to current month when entering edit page
                currentViewMonth = new Date().getMonth();
                currentViewYear = new Date().getFullYear();
                updateMonthDisplay();
                renderDetailChart();
                renderDataTable();
            }, 100);
        }

        function hideAllPages() {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
        }

        function updateBreadcrumb(items) {
            document.getElementById('breadcrumb').textContent = items.join(' > ');
        }

        function showRoomPageFromEdit() {
            if (!currentRoom) return;
            showRoomPage(currentRoom.id);
        }

        // Month Navigation Functions
        function changeMonth(direction) {
            currentViewMonth += direction;
            if (currentViewMonth > 11) {
                currentViewMonth = 0;
                currentViewYear++;
            } else if (currentViewMonth < 0) {
                currentViewMonth = 11;
                currentViewYear--;
            }
            updateMonthDisplay();
            renderDetailChart();
            renderDataTable();
        }

        function updateMonthDisplay() {
            const monthNames = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            document.getElementById('currentMonthDisplay').textContent = 
                `${monthNames[currentViewMonth]} ${currentViewYear}`;
        }

        // Room Management
        let selectedColor = 'blue'; // Default color

        function showAddRoomForm() {
            document.getElementById('addRoomForm').classList.remove('hidden');
            // Reset color selection to default
            selectedColor = 'blue';
            selectColor('blue');
        }

        function hideAddRoomForm() {
            document.getElementById('addRoomForm').classList.add('hidden');
            document.getElementById('roomNameInput').value = '';
            
            // Reset color selection
            selectedColor = 'blue';
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('ring-4', 'ring-gray-800');
            });
            
            // Reset form to add mode
            editingRoomId = null;
            const submitBtn = document.querySelector('#addRoomForm button[onclick="addRoom()"]');
            submitBtn.textContent = 'Tambah';
            submitBtn.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-semibold transition duration-300';
            document.querySelector('#addRoomForm h3').textContent = 'Tambah Ruangan Baru';
        }

        function selectColor(color) {
            selectedColor = color;
            
            // Remove selection from all options
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('ring-4', 'ring-gray-800');
            });
            
            // Add selection to clicked option
            const selectedOption = document.querySelector(`[data-color="${color}"]`);
            if (selectedOption) {
                selectedOption.classList.add('ring-4', 'ring-gray-800');
            }
        }

        let editingRoomId = null;

        function addRoom() {
            const name = document.getElementById('roomNameInput').value.trim();
            if (!name) return;

            if (editingRoomId) {
                // Edit mode
                const roomIndex = rooms.findIndex(r => r.id === editingRoomId);
                if (roomIndex >= 0) {
                    rooms[roomIndex].name = name;
                    rooms[roomIndex].color = selectedColor; // Update color too
                    localStorage.setItem('rooms', JSON.stringify(rooms));
                    
                    // Auto-save to Supabase
                    saveToSupabase(rooms[roomIndex]);
                    
                    showSuccessMessage('Ruangan berhasil diperbarui!');
                    editingRoomId = null;
                    
                    // Reset form button
                    const submitBtn = document.querySelector('#addRoomForm button[onclick="addRoom()"]');
                    submitBtn.textContent = 'Tambah';
                    submitBtn.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-semibold transition duration-300';
                    
                    // Update form title
                    document.querySelector('#addRoomForm h3').textContent = 'Tambah Ruangan Baru';
                }
            } else {
                // Add mode
                const room = {
                    id: Date.now().toString(),
                    name: name,
                    color: selectedColor, // Save selected color
                    data: {
                        temperature: [],
                        humidity: [],
                        fridge: []
                    }
                };

                rooms.push(room);
                localStorage.setItem('rooms', JSON.stringify(rooms));
                
                // Auto-save to Supabase
                saveToSupabase(room);
                
                showSuccessMessage('Ruangan baru berhasil ditambahkan!');
            }

            hideAddRoomForm();
            renderRooms();
        }

        function editRoom(roomId) {
            const room = rooms.find(r => r.id === roomId);
            if (!room) return;

            editingRoomId = roomId;
            document.getElementById('roomNameInput').value = room.name;
            
            // Set the current room color as selected
            selectedColor = room.color || 'blue';
            selectColor(selectedColor);
            
            document.getElementById('addRoomForm').classList.remove('hidden');
            
            // Update form for edit mode
            const submitBtn = document.querySelector('#addRoomForm button[onclick="addRoom()"]');
            submitBtn.textContent = 'Update';
            submitBtn.className = 'flex-1 bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg font-semibold transition duration-300';
            
            // Update form title
            document.querySelector('#addRoomForm h3').textContent = 'Edit Ruangan';
        }

        function deleteRoom(roomId) {
            const room = rooms.find(r => r.id === roomId);
            if (!room) return;

            // Show confirmation
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
            confirmDiv.style.zIndex = '9997';
            confirmDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-4">
                    <h3 class="text-lg font-semibold mb-4">Konfirmasi Hapus Ruangan</h3>
                    <p class="text-gray-600 mb-2">Apakah Anda yakin ingin menghapus ruangan:</p>
                    <p class="font-semibold text-gray-800 mb-4">"${room.name}"</p>
                    <p class="text-red-600 text-sm mb-6">‚ö†Ô∏è Semua data monitoring akan ikut terhapus!</p>
                    <div class="flex gap-3">
                        <button onclick="confirmDeleteRoom('${roomId}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-semibold transition duration-300">
                            Hapus
                        </button>
                        <button onclick="cancelDeleteRoom()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold transition duration-300">
                            Batal
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);
        }

        function confirmDeleteRoom(roomId) {
            const roomIndex = rooms.findIndex(r => r.id === roomId);
            if (roomIndex >= 0) {
                const roomName = rooms[roomIndex].name;
                
                // Delete from Supabase first
                deleteFromSupabase(roomId);
                
                rooms.splice(roomIndex, 1);
                localStorage.setItem('rooms', JSON.stringify(rooms));
                renderRooms();
                showSuccessMessage(`Ruangan "${roomName}" berhasil dihapus!`);
                
                // If we're currently viewing this room, go back to home
                if (currentRoom && currentRoom.id === roomId) {
                    showHomePage();
                }
            }
            cancelDeleteRoom();
        }

        function cancelDeleteRoom() {
            const confirmDiv = document.querySelector('.fixed.inset-0');
            if (confirmDiv) {
                confirmDiv.remove();
            }
        }

        function renderRooms() {
            const grid = document.getElementById('roomGrid');
            grid.innerHTML = '';

            // Color mapping for room cards
            const colorClasses = {
                blue: 'bg-gradient-to-br from-blue-400 to-blue-600',
                green: 'bg-gradient-to-br from-green-400 to-green-600',
                purple: 'bg-gradient-to-br from-purple-400 to-purple-600',
                pink: 'bg-gradient-to-br from-pink-400 to-pink-600',
                indigo: 'bg-gradient-to-br from-indigo-400 to-indigo-600',
                teal: 'bg-gradient-to-br from-teal-400 to-teal-600',
                orange: 'bg-gradient-to-br from-orange-400 to-orange-600',
                red: 'bg-gradient-to-br from-red-400 to-red-600',
                cyan: 'bg-gradient-to-br from-cyan-400 to-cyan-600',
                emerald: 'bg-gradient-to-br from-emerald-400 to-emerald-600'
            };

            rooms.forEach((room, index) => {
                const card = document.createElement('div');
                // Use room's saved color or fallback to default pattern
                const roomColor = room.color || Object.keys(colorClasses)[index % Object.keys(colorClasses).length];
                const colorClass = colorClasses[roomColor] || colorClasses.blue;
                
                card.className = `${colorClass} p-6 rounded-lg card-shadow cursor-pointer hover:shadow-xl transition duration-300 text-white`;
                card.onclick = () => showRoomPage(room.id);
                
                card.innerHTML = `
                    <div class="mb-2">
                        <h3 class="text-xl font-semibold text-white">${room.name}</h3>
                    </div>
                    <p class="text-white text-opacity-90 mb-4">Klik untuk melihat monitoring</p>
                    <div class="flex justify-between text-sm text-white text-opacity-80 mb-4">
                        <span>Suhu: ${getLatestValue(room, 'temperature')}¬∞C</span>
                        <span>Kelembaban: ${getLatestValue(room, 'humidity')}%</span>
                        <span>Kulkas: ${getLatestValue(room, 'fridge')}¬∞C</span>
                    </div>
                    <div class="flex gap-2 pt-3 border-t border-white border-opacity-30">
                        <button onclick="event.stopPropagation(); editRoom('${room.id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition duration-300 flex items-center justify-center gap-1">
                            ‚úèÔ∏è Edit
                        </button>
                        <button onclick="event.stopPropagation(); deleteRoom('${room.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition duration-300 flex items-center justify-center gap-1">
                            üóëÔ∏è Hapus
                        </button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function getLatestValue(room, type) {
            const data = room.data[type];
            return data.length > 0 ? data[data.length - 1].value : '--';
        }

        // Chart Functions
        function renderSummaryCharts() {
            const types = ['temperature', 'humidity', 'fridge'];
            
            // Define normal ranges
            const normalRanges = {
                temperature: { min: 15, max: 25 },
                humidity: { min: 40, max: 60 },
                fridge: { min: 2, max: 8 }
            };
            
            types.forEach(type => {
                const ctx = document.getElementById(type === 'temperature' ? 'tempChart' : 
                                                 type === 'humidity' ? 'humidityChart' : 'fridgeChart');
                
                if (charts[type]) {
                    charts[type].destroy();
                }

                const data = currentRoom.data[type] || [];
                const last7Days = data.slice(-14); // Show last 14 data points
                const currentRange = normalRanges[type];

                // Create point colors based on normal range
                const pointColors = last7Days.map(d => {
                    const isNormal = d.value >= currentRange.min && d.value <= currentRange.max;
                    return isNormal ? '#22c55e' : '#ef4444'; // Green for normal, red for abnormal
                });

                charts[type] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(d => `${d.date} (${d.shift})`),
                        datasets: [{
                            label: type === 'temperature' ? 'Suhu Ruangan' : 
                                   type === 'humidity' ? 'Kelembaban' : 'Suhu Kulkas',
                            data: last7Days.map(d => d.value),
                            borderColor: '#3b82f6',
                            backgroundColor: '#eff6ff',
                            pointBackgroundColor: pointColors,
                            pointBorderColor: pointColors,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const value = context.parsed.y;
                                        const isNormal = value >= currentRange.min && value <= currentRange.max;
                                        return [
                                            `Status: ${isNormal ? 'Normal' : 'Abnormal'}`,
                                            `Rentang Normal: ${currentRange.min} - ${currentRange.max}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            });
        }

        function renderDetailChart() {
            const ctx = document.getElementById('detailChart');
            
            if (charts.detail) {
                charts.detail.destroy();
            }

            const data = currentRoom.data[currentDataType] || [];
            
            // Define normal ranges
            const normalRanges = {
                temperature: { min: 15, max: 25 },
                humidity: { min: 40, max: 60 },
                fridge: { min: 2, max: 8 }
            };
            
            const currentRange = normalRanges[currentDataType];
            
            // Generate all days of selected month
            const year = currentViewYear;
            const month = currentViewMonth;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Create combined data points for ALL dates and shifts
            const combinedLabels = [];
            const combinedData = [];
            const pointColors = [];

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                // Add morning data point (always add label, null if no data)
                const morningEntry = data.find(d => d.date === dateStr && d.shift === 'pagi');
                combinedLabels.push(`${i}P`);
                if (morningEntry) {
                    combinedData.push(morningEntry.value);
                    // Check if value is within normal range
                    const isNormal = morningEntry.value >= currentRange.min && morningEntry.value <= currentRange.max;
                    pointColors.push(isNormal ? '#22c55e' : '#ef4444'); // Green for normal, red for abnormal
                } else {
                    combinedData.push(null);
                    pointColors.push('#22c55e'); // Default color for null values
                }
                
                // Add evening data point (always add label, null if no data)
                const eveningEntry = data.find(d => d.date === dateStr && d.shift === 'malam');
                combinedLabels.push(`${i}M`);
                if (eveningEntry) {
                    combinedData.push(eveningEntry.value);
                    // Check if value is within normal range
                    const isNormal = eveningEntry.value >= currentRange.min && eveningEntry.value <= currentRange.max;
                    pointColors.push(isNormal ? '#22c55e' : '#ef4444'); // Green for normal, red for abnormal
                } else {
                    combinedData.push(null);
                    pointColors.push('#22c55e'); // Default color for null values
                }
            }

            // Set Y-axis configuration based on data type
            let yAxisConfig = {};
            if (currentDataType === 'temperature') {
                yAxisConfig = { min: 10, max: 30, stepSize: 2 };
            } else if (currentDataType === 'humidity') {
                yAxisConfig = { min: 30, max: 80, stepSize: 5 };
            } else if (currentDataType === 'fridge') {
                yAxisConfig = { 
                    min: -2, 
                    max: 13, 
                    ticks: {
                        stepSize: 1
                    }
                };
            }

            // Create datasets with normal range bands
            const datasets = [
                // Normal range background
                {
                    label: 'Rentang Normal',
                    data: combinedLabels.map(() => currentRange.max),
                    borderColor: 'rgba(34, 197, 94, 0.3)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: '+1',
                    tension: 0,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    borderWidth: 1,
                    order: 3
                },
                {
                    label: '',
                    data: combinedLabels.map(() => currentRange.min),
                    borderColor: 'rgba(34, 197, 94, 0.3)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: false,
                    tension: 0,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    borderWidth: 1,
                    order: 3
                },
                // Main data line
                {
                    label: 'Data Monitoring',
                    data: combinedData,
                    borderColor: '#000000', // Black line
                    backgroundColor: 'transparent',
                    tension: 0.4,
                    fill: false,
                    pointBackgroundColor: pointColors,
                    pointBorderColor: pointColors,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    spanGaps: false, // Don't connect across missing data
                    borderWidth: 2,
                    order: 1
                }
            ];

            charts.detail = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: combinedLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: yAxisConfig,
                        x: {
                            title: {
                                display: true,
                                text: 'Tanggal dan Shift (P=Pagi, M=Malam)'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                filter: function(item, chart) {
                                    // Only show legend for main data and normal range
                                    return item.text !== '';
                                }
                            }
                        },
                        tooltip: {
                            filter: function(tooltipItem) {
                                // Only show tooltip for main data line (dataset index 2)
                                return tooltipItem.datasetIndex === 2;
                            },
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 2 && context.parsed.y !== null) { // Main data line
                                        // Find the corresponding data entry to get operator name
                                        const labelIndex = context.dataIndex;
                                        const dayNumber = Math.floor(labelIndex / 2) + 1;
                                        const isEvening = labelIndex % 2 === 1;
                                        const shift = isEvening ? 'malam' : 'pagi';
                                        
                                        const dateStr = `${currentViewYear}-${String(currentViewMonth + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
                                        const dataEntry = data.find(d => d.date === dateStr && d.shift === shift);
                                        
                                        let result = [];
                                        if (dataEntry && dataEntry.operator) {
                                            result.push(`Pengisi: ${dataEntry.operator}`);
                                        }
                                        
                                        // Add status information
                                        const value = context.parsed.y;
                                        const isNormal = value >= currentRange.min && value <= currentRange.max;
                                        result.push(`Status: ${isNormal ? 'Normal' : 'Abnormal'}`);
                                        result.push(`Rentang Normal: ${currentRange.min} - ${currentRange.max}`);
                                        
                                        return result;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Data Management
        let editingDataId = null;

        function addDataPoint(event) {
            event.preventDefault();
            
            const date = document.getElementById('dateInput').value;
            const shift = document.getElementById('shiftInput').value;
            const value = parseFloat(document.getElementById('valueInput').value);
            const operator = document.getElementById('operatorInput').value;

            if (!date || !shift || isNaN(value) || !operator) {
                showErrorMessage('Mohon lengkapi semua field!');
                return;
            }

            // Initialize data array if it doesn't exist
            if (!currentRoom.data[currentDataType]) {
                currentRoom.data[currentDataType] = [];
            }

            // Check if entry already exists for this date and shift
            const existingIndex = currentRoom.data[currentDataType].findIndex(
                d => d.date === date && d.shift === shift
            );

            // Check if value is outside normal range
            const normalRanges = {
                temperature: { min: 15, max: 25 },
                humidity: { min: 40, max: 60 },
                fridge: { min: 2, max: 8 }
            };
            
            const currentRange = normalRanges[currentDataType];
            const isAbnormal = value < currentRange.min || value > currentRange.max;

            if (editingDataId) {
                // Edit mode
                const editIndex = currentRoom.data[currentDataType].findIndex(d => d.id === editingDataId);
                if (editIndex >= 0) {
                    const oldValue = currentRoom.data[currentDataType][editIndex].value;
                    const wasAbnormal = oldValue < currentRange.min || oldValue > currentRange.max;
                    
                    currentRoom.data[currentDataType][editIndex] = {
                        ...currentRoom.data[currentDataType][editIndex],
                        value,
                        operator,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Auto-save to Supabase
                    saveToSupabase(currentRoom, currentDataType, currentRoom.data[currentDataType][editIndex]);
                    
                    // Send notification if value changed from normal to abnormal
                    if (!wasAbnormal && isAbnormal) {
                        sendAbnormalValueNotification(value, date, shift, operator);
                    }
                    
                    showSuccessMessage('Data berhasil diperbarui!');
                    cancelEdit();
                }
            } else {
                // Add mode
                if (existingIndex >= 0) {
                    showErrorMessage('Data untuk tanggal dan shift ini sudah ada! Gunakan tombol Edit untuk mengubah.');
                    return;
                }

                const dataPoint = {
                    id: Date.now().toString(),
                    date,
                    shift,
                    value,
                    operator,
                    timestamp: new Date().toISOString()
                };

                currentRoom.data[currentDataType].push(dataPoint);
                
                // Auto-save to Supabase
                saveToSupabase(currentRoom, currentDataType, dataPoint);
                
                // Send notification if value is abnormal
                if (isAbnormal) {
                    sendAbnormalValueNotification(value, date, shift, operator);
                }
                
                showSuccessMessage('Data berhasil ditambahkan!');
            }

            // Sort by date and shift
            currentRoom.data[currentDataType].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.shift === 'pagi' ? -1 : 1;
            });

            // Update the rooms array
            const roomIndex = rooms.findIndex(r => r.id === currentRoom.id);
            if (roomIndex >= 0) {
                rooms[roomIndex] = currentRoom;
            }

            localStorage.setItem('rooms', JSON.stringify(rooms));
            
            // Reset form
            document.getElementById('dateInput').value = '';
            document.getElementById('shiftInput').value = '';
            document.getElementById('valueInput').value = '';
            document.getElementById('operatorInput').value = '';

            renderDetailChart();
            renderDataTable();
        }

        function editDataPoint(id) {
            const dataPoint = currentRoom.data[currentDataType].find(d => d.id === id);
            if (!dataPoint) return;

            editingDataId = id;
            document.getElementById('dateInput').value = dataPoint.date;
            document.getElementById('shiftInput').value = dataPoint.shift;
            document.getElementById('valueInput').value = dataPoint.value;
            document.getElementById('operatorInput').value = dataPoint.operator;

            // Update form button
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Data';
            submitBtn.className = 'w-full bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg font-semibold transition duration-300';

            // Add cancel button
            if (!document.getElementById('cancelEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'cancelEditBtn';
                cancelBtn.type = 'button';
                cancelBtn.onclick = cancelEdit;
                cancelBtn.className = 'w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold transition duration-300';
                cancelBtn.textContent = 'Batal Edit';
                submitBtn.parentNode.appendChild(cancelBtn);
            }

            // Disable date and shift fields during edit
            document.getElementById('dateInput').disabled = true;
            document.getElementById('shiftInput').disabled = true;
        }

        function cancelEdit() {
            editingDataId = null;
            
            // Reset form
            document.getElementById('dateInput').value = '';
            document.getElementById('shiftInput').value = '';
            document.getElementById('valueInput').value = '';
            document.getElementById('operatorInput').value = '';
            
            // Enable date and shift fields
            document.getElementById('dateInput').disabled = false;
            document.getElementById('shiftInput').disabled = false;

            // Reset form button
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Tambah Data';
            submitBtn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition duration-300';

            // Remove cancel button
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
        }

        function renderDataTable() {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';

            const data = currentRoom.data[currentDataType] || [];
            
            // Filter data for selected month and year
            const filteredData = data.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getMonth() === currentViewMonth && entryDate.getFullYear() === currentViewYear;
            });
            
            filteredData.forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2">${entry.date}</td>
                    <td class="px-4 py-2 capitalize">${entry.shift}</td>
                    <td class="px-4 py-2">${entry.value}</td>
                    <td class="px-4 py-2">${entry.operator}</td>
                    <td class="px-4 py-2">
                        <button onclick="editDataPoint('${entry.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium mr-3">
                            Edit
                        </button>
                        <button onclick="deleteDataPoint('${entry.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                            Hapus
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteDataPoint(id) {
            // Show confirmation
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
            confirmDiv.style.zIndex = '9997';
            confirmDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-4">
                    <h3 class="text-lg font-semibold mb-4">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus data ini?</p>
                    <div class="flex gap-3">
                        <button onclick="confirmDelete('${id}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-semibold transition duration-300">
                            Hapus
                        </button>
                        <button onclick="cancelDelete()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold transition duration-300">
                            Batal
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);
        }

        function confirmDelete(id) {
            const index = currentRoom.data[currentDataType].findIndex(d => d.id === id);
            if (index >= 0) {
                // Delete from Supabase first
                deleteFromSupabase(currentRoom.id, id);
                
                currentRoom.data[currentDataType].splice(index, 1);
                
                // Update the rooms array
                const roomIndex = rooms.findIndex(r => r.id === currentRoom.id);
                if (roomIndex >= 0) {
                    rooms[roomIndex] = currentRoom;
                }
                
                localStorage.setItem('rooms', JSON.stringify(rooms));
                renderDetailChart();
                renderDataTable();
                showSuccessMessage('Data berhasil dihapus!');
            }
            cancelDelete();
        }

        function cancelDelete() {
            const confirmDiv = document.querySelector('.fixed.inset-0');
            if (confirmDiv) {
                confirmDiv.remove();
            }
        }

        // Abnormal Value Notification
        function sendAbnormalValueNotification(value, date, shift, operator) {
            // Show popup notification for abnormal values
            showAbnormalValueAlert(value, date, shift, operator);
        }

        function showAbnormalValueAlert(value, date, shift, operator) {
            const dataTypeNames = {
                temperature: 'Suhu Ruangan',
                humidity: 'Kelembaban',
                fridge: 'Suhu Kulkas'
            };

            const normalRanges = {
                temperature: { min: 15, max: 25, unit: '¬∞C' },
                humidity: { min: 40, max: 60, unit: '%' },
                fridge: { min: 2, max: 8, unit: '¬∞C' }
            };

            const range = normalRanges[currentDataType];
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
            alertDiv.style.zIndex = '9996';
            alertDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-md mx-4 border-l-4 border-red-500">
                    <div class="flex items-center mb-4">
                        <div class="bg-red-100 p-2 rounded-full mr-3">
                            <span class="text-red-600 text-xl">‚ö†Ô∏è</span>
                        </div>
                        <h3 class="text-lg font-semibold text-red-800">Nilai Abnormal Terdeteksi!</h3>
                    </div>
                    <div class="space-y-2 text-sm text-gray-700 mb-4">
                        <p><strong>Ruangan:</strong> ${currentRoom.name}</p>
                        <p><strong>Parameter:</strong> ${dataTypeNames[currentDataType]}</p>
                        <p><strong>Nilai:</strong> <span class="text-red-600 font-semibold">${value}${range.unit}</span></p>
                        <p><strong>Rentang Normal:</strong> ${range.min} - ${range.max}${range.unit}</p>
                        <p><strong>Tanggal:</strong> ${date}</p>
                        <p><strong>Shift:</strong> ${shift.charAt(0).toUpperCase() + shift.slice(1)}</p>
                        <p><strong>Pengisi:</strong> ${operator}</p>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg mb-4">
                        <p class="text-yellow-800 text-sm">
                            üö® <strong>Perhatian:</strong> Nilai berada di luar rentang normal. Mohon segera lakukan pengecekan dan tindakan yang diperlukan.
                        </p>
                    </div>
                    <div class="text-center">
                        <button onclick="closeAbnormalAlert()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg font-semibold transition duration-300">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(alertDiv);
        }

        function closeAbnormalAlert() {
            const alertDiv = document.querySelector('.fixed.inset-0');
            if (alertDiv) {
                alertDiv.remove();
            }
        }

        function showSuccessMessage(message) {
            // Create success message element
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // Remove message after 3 seconds
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        function showErrorMessage(message) {
            // Create error message element
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // Remove message after 4 seconds
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 4000);
        }

        // ===== PDF CONFIGURATION FUNCTIONS =====
        
        // Show PDF configuration modal
        function showPDFConfigModal() {
            // Load saved configuration
            const savedConfig = localStorage.getItem('pdfHeaderConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('hospitalName').value = config.hospitalName || '';
                document.getElementById('hospitalAddress').value = config.hospitalAddress || '';
                document.getElementById('hospitalPhone').value = config.hospitalPhone || '';
                document.getElementById('hospitalEmail').value = config.hospitalEmail || '';
                document.getElementById('logo1Url').value = config.logo1Url || '';
                document.getElementById('logo2Url').value = config.logo2Url || '';
            }
            
            document.getElementById('pdfConfigModal').classList.remove('hidden');
        }

        // Hide PDF configuration modal
        function hidePDFConfigModal() {
            document.getElementById('pdfConfigModal').classList.add('hidden');
        }

        // Save PDF configuration and export
        function savePDFConfigAndExport() {
            const hospitalName = document.getElementById('hospitalName').value.trim();
            
            if (!hospitalName) {
                showErrorMessage('Nama rumah sakit wajib diisi!');
                return;
            }

            const config = {
                hospitalName: hospitalName,
                hospitalAddress: document.getElementById('hospitalAddress').value.trim(),
                hospitalPhone: document.getElementById('hospitalPhone').value.trim(),
                hospitalEmail: document.getElementById('hospitalEmail').value.trim(),
                logo1Url: document.getElementById('logo1Url').value.trim(),
                logo2Url: document.getElementById('logo2Url').value.trim()
            };

            // Save configuration
            localStorage.setItem('pdfHeaderConfig', JSON.stringify(config));
            
            // Hide modal and export PDF
            hidePDFConfigModal();
            exportToPDF(config);
            
            showSuccessMessage('Konfigurasi disimpan dan PDF berhasil diexport!');
        }

        // ===== SUPABASE INTEGRATION =====
        let supabaseClient = null;

        // Load Supabase configuration on page load
        function loadSupabaseConfig() {
            const config = localStorage.getItem('supabaseConfig');
            if (config) {
                const { url, key } = JSON.parse(config);
                document.getElementById('supabaseUrl').value = url;
                document.getElementById('supabaseKey').value = key;
                initializeSupabase(url, key);
            }
        }

        // Initialize Supabase client
        function initializeSupabase(url, key) {
            try {
                // Create Supabase client using CDN
                supabaseClient = {
                    url: url,
                    key: key,
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    }
                };
                updateConnectionStatus('connected', 'Terhubung ke Supabase');
                logActivity('‚úÖ Koneksi Supabase berhasil diinisialisasi');
                return true;
            } catch (error) {
                updateConnectionStatus('error', 'Gagal menginisialisasi Supabase');
                logActivity('‚ùå Error inisialisasi: ' + error.message);
                return false;
            }
        }

        // Show/Hide Supabase config panel
        function showSupabaseConfig() {
            document.getElementById('supabaseConfigPanel').classList.remove('hidden');
            loadSupabaseConfig();
        }

        function hideSupabaseConfig() {
            document.getElementById('supabaseConfigPanel').classList.add('hidden');
        }

        // Test connection to Supabase
        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();

            if (!url || !key) {
                showErrorMessage('Mohon isi URL dan API Key terlebih dahulu!');
                return;
            }

            // Validate URL format
            if (!url.includes('supabase.co') && !url.includes('localhost')) {
                showErrorMessage('URL harus berupa URL Supabase yang valid (contoh: https://xxx.supabase.co)');
                return;
            }

            updateConnectionStatus('testing', 'Menguji koneksi...');
            logActivity('üîç Menguji koneksi ke Supabase...');

            try {
                // Test connection with a simple health check
                const testUrl = `${url}/rest/v1/`;
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok || response.status === 200) {
                    updateConnectionStatus('connected', 'Koneksi berhasil!');
                    logActivity('‚úÖ Koneksi berhasil! Supabase siap digunakan');
                    initializeSupabase(url, key);
                    showSuccessMessage('Koneksi ke Supabase berhasil!');
                } else if (response.status === 401) {
                    throw new Error('API Key tidak valid atau tidak memiliki akses. Pastikan menggunakan "anon/public" key dari Settings ‚Üí API');
                } else if (response.status === 404) {
                    throw new Error('URL Supabase tidak ditemukan. Periksa kembali Project URL Anda');
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
                }
            } catch (error) {
                let errorMessage = error.message;
                
                // Provide more helpful error messages
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = 'Tidak dapat terhubung ke Supabase. Periksa koneksi internet dan URL project Anda.';
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'Error CORS. Pastikan domain ini diizinkan di pengaturan Supabase Anda.';
                }
                
                updateConnectionStatus('error', 'Koneksi gagal: ' + errorMessage);
                logActivity('‚ùå Koneksi gagal: ' + errorMessage);
                showErrorMessage('Koneksi gagal: ' + errorMessage);
            }
        }

        // Save Supabase configuration
        function saveSupabaseConfig() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();

            if (!url || !key) {
                showErrorMessage('Mohon isi URL dan API Key terlebih dahulu!');
                return;
            }

            const config = { url, key };
            localStorage.setItem('supabaseConfig', JSON.stringify(config));
            initializeSupabase(url, key);
            logActivity('üíæ Konfigurasi Supabase berhasil disimpan');
            showSuccessMessage('Konfigurasi Supabase berhasil disimpan!');
        }



        // Sync all data to Supabase
        async function syncAllData() {
            if (!supabaseClient) {
                showErrorMessage('Mohon konfigurasi Supabase terlebih dahulu!');
                return;
            }

            logActivity('üîÑ Memulai sinkronisasi data ke Supabase...');

            try {
                let syncedRooms = 0;
                let syncedData = 0;

                for (const room of rooms) {
                    // Sync room
                    await saveRoomToSupabase(room);
                    syncedRooms++;

                    // Sync all monitoring data for this room
                    for (const dataType of ['temperature', 'humidity', 'fridge']) {
                        if (room.data[dataType]) {
                            for (const dataPoint of room.data[dataType]) {
                                await saveDataToSupabase(room.id, dataType, dataPoint);
                                syncedData++;
                            }
                        }
                    }
                }

                logActivity(`‚úÖ Sinkronisasi selesai: ${syncedRooms} ruangan, ${syncedData} data point`);
                showSuccessMessage(`Sinkronisasi selesai! ${syncedRooms} ruangan dan ${syncedData} data berhasil disimpan.`);
            } catch (error) {
                logActivity('‚ùå Error sinkronisasi: ' + error.message);
                showErrorMessage('Error sinkronisasi: ' + error.message);
            }
        }

        // Load data from Supabase
        async function loadFromSupabase() {
            if (!supabaseClient) {
                showErrorMessage('Mohon konfigurasi Supabase terlebih dahulu!');
                return;
            }

            logActivity('üì• Memuat data dari Supabase...');

            try {
                // Load rooms
                const roomsResponse = await fetch(`${supabaseClient.url}/rest/v1/rooms`, {
                    method: 'GET',
                    headers: supabaseClient.headers
                });

                if (roomsResponse.ok) {
                    const supabaseRooms = await roomsResponse.json();
                    
                    // Load monitoring data
                    const dataResponse = await fetch(`${supabaseClient.url}/rest/v1/monitoring_data`, {
                        method: 'GET',
                        headers: supabaseClient.headers
                    });

                    if (dataResponse.ok) {
                        const supabaseData = await dataResponse.json();
                        
                        // Reconstruct rooms with data
                        const loadedRooms = supabaseRooms.map(room => ({
                            id: room.id,
                            name: room.name,
                            color: room.color || 'blue',
                            data: {
                                temperature: supabaseData.filter(d => d.room_id === room.id && d.data_type === 'temperature'),
                                humidity: supabaseData.filter(d => d.room_id === room.id && d.data_type === 'humidity'),
                                fridge: supabaseData.filter(d => d.room_id === room.id && d.data_type === 'fridge')
                            }
                        }));

                        // Update local storage
                        rooms = loadedRooms;
                        localStorage.setItem('rooms', JSON.stringify(rooms));
                        renderRooms();

                        logActivity(`‚úÖ Data berhasil dimuat: ${loadedRooms.length} ruangan, ${supabaseData.length} data point`);
                        showSuccessMessage(`Data berhasil dimuat dari cloud! ${loadedRooms.length} ruangan dan ${supabaseData.length} data.`);
                    } else {
                        throw new Error('Gagal memuat data monitoring');
                    }
                } else {
                    throw new Error('Gagal memuat data ruangan');
                }
            } catch (error) {
                logActivity('‚ùå Error memuat data: ' + error.message);
                showErrorMessage('Error memuat data: ' + error.message);
            }
        }

        // Save room to Supabase
        async function saveRoomToSupabase(room) {
            if (!supabaseClient) return;

            try {
                const response = await fetch(`${supabaseClient.url}/rest/v1/rooms`, {
                    method: 'POST',
                    headers: {
                        ...supabaseClient.headers,
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify({
                        id: room.id,
                        name: room.name,
                        color: room.color || 'blue',
                        updated_at: new Date().toISOString()
                    })
                });

                if (!response.ok && response.status !== 409) { // 409 is conflict (duplicate)
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error saving room to Supabase:', error);
            }
        }

        // Save monitoring data to Supabase
        async function saveDataToSupabase(roomId, dataType, dataPoint) {
            if (!supabaseClient) return;

            try {
                const response = await fetch(`${supabaseClient.url}/rest/v1/monitoring_data`, {
                    method: 'POST',
                    headers: {
                        ...supabaseClient.headers,
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify({
                        id: dataPoint.id,
                        room_id: roomId,
                        data_type: dataType,
                        date: dataPoint.date,
                        shift: dataPoint.shift,
                        value: dataPoint.value,
                        operator: dataPoint.operator,
                        timestamp: dataPoint.timestamp || new Date().toISOString()
                    })
                });

                if (!response.ok && response.status !== 409) { // 409 is conflict (duplicate)
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error saving data to Supabase:', error);
            }
        }

        // Auto-save functions (called when data changes)
        async function saveToSupabase(room, dataType = null, dataPoint = null) {
            if (!supabaseClient) return;

            try {
                // Save room
                await saveRoomToSupabase(room);

                // Save specific data point if provided
                if (dataType && dataPoint) {
                    await saveDataToSupabase(room.id, dataType, dataPoint);
                }
            } catch (error) {
                console.error('Auto-save to Supabase failed:', error);
            }
        }

        // Delete from Supabase
        async function deleteFromSupabase(roomId, dataId = null) {
            if (!supabaseClient) return;

            try {
                if (dataId) {
                    // Delete specific data point
                    await fetch(`${supabaseClient.url}/rest/v1/monitoring_data?id=eq.${dataId}`, {
                        method: 'DELETE',
                        headers: supabaseClient.headers
                    });
                } else {
                    // Delete entire room and its data
                    await fetch(`${supabaseClient.url}/rest/v1/rooms?id=eq.${roomId}`, {
                        method: 'DELETE',
                        headers: supabaseClient.headers
                    });
                }
            } catch (error) {
                console.error('Error deleting from Supabase:', error);
            }
        }

        // Clear Supabase configuration
        function clearSupabaseConfig() {
            localStorage.removeItem('supabaseConfig');
            document.getElementById('supabaseUrl').value = '';
            document.getElementById('supabaseKey').value = '';
            supabaseClient = null;
            updateConnectionStatus('disconnected', 'Konfigurasi dihapus');
            logActivity('üóëÔ∏è Konfigurasi Supabase berhasil dihapus');
            showSuccessMessage('Konfigurasi Supabase berhasil dihapus!');
        }

        // Update connection status display
        function updateConnectionStatus(status, message) {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const statusDiv = document.getElementById('connectionStatus');

            switch (status) {
                case 'connected':
                    statusIcon.textContent = 'üü¢';
                    statusText.textContent = message;
                    statusDiv.className = 'mb-6 p-4 rounded-lg bg-green-100';
                    break;
                case 'testing':
                    statusIcon.textContent = 'üü°';
                    statusText.textContent = message;
                    statusDiv.className = 'mb-6 p-4 rounded-lg bg-yellow-100';
                    break;
                case 'error':
                    statusIcon.textContent = 'üî¥';
                    statusText.textContent = message;
                    statusDiv.className = 'mb-6 p-4 rounded-lg bg-red-100';
                    break;
                case 'disconnected':
                    statusIcon.textContent = '‚ö™';
                    statusText.textContent = message;
                    statusDiv.className = 'mb-6 p-4 rounded-lg bg-gray-100';
                    break;
            }
        }

        // Log activity
        function logActivity(message) {
            const logDiv = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            if (logDiv.children.length === 1 && logDiv.children[0].textContent === 'Belum ada aktivitas...') {
                logDiv.innerHTML = '';
            }
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // SQL Modal Functions
        function showManualSQL() {
            document.getElementById('sqlModal').classList.remove('hidden');
        }

        function hideManualSQL() {
            document.getElementById('sqlModal').classList.add('hidden');
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            // Create temporary textarea
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showSuccessMessage('Script SQL berhasil disalin ke clipboard!');
            } catch (err) {
                showErrorMessage('Gagal menyalin ke clipboard. Silakan copy manual.');
            }
            
            document.body.removeChild(textarea);
        }

        // Initialize page on load (remove duplicate)
        // This replaces the previous DOMContentLoaded listener

        // Export and Config Menu Functions
        function exportPDFDirect() {
            const savedConfig = localStorage.getItem('pdfHeaderConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                exportToPDF(config);
            } else {
                // If no saved config, use default
                const defaultConfig = {
                    hospitalName: 'RUMAH SAKIT UMUM DAERAH',
                    hospitalAddress: '',
                    hospitalPhone: '',
                    hospitalEmail: '',
                    logo1Url: '',
                    logo2Url: ''
                };
                exportToPDF(defaultConfig);
                showErrorMessage('Menggunakan konfigurasi default. Gunakan tombol "Konfigurasi" untuk mengatur header PDF.');
            }
        }

        function toggleConfigMenu() {
            const dropdown = document.getElementById('configDropdown');
            
            // Load saved configuration when opening
            if (dropdown.classList.contains('hidden')) {
                loadQuickConfigForm();
            }
            
            dropdown.classList.toggle('hidden');
        }

        function hideConfigMenu() {
            const dropdown = document.getElementById('configDropdown');
            dropdown.classList.add('hidden');
        }

        function loadQuickConfigForm() {
            const savedConfig = localStorage.getItem('pdfHeaderConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('quickHospitalName').value = config.hospitalName || '';
                document.getElementById('quickHospitalAddress').value = config.hospitalAddress || '';
                document.getElementById('quickHospitalPhone').value = config.hospitalPhone || '';
                document.getElementById('quickHospitalEmail').value = config.hospitalEmail || '';
                document.getElementById('quickLogo1Url').value = config.logo1Url || '';
                document.getElementById('quickLogo2Url').value = config.logo2Url || '';
            }
        }

        function saveQuickConfig() {
            const hospitalName = document.getElementById('quickHospitalName').value.trim();
            
            if (!hospitalName) {
                showErrorMessage('Nama rumah sakit wajib diisi!');
                return;
            }

            const config = {
                hospitalName: hospitalName,
                hospitalAddress: document.getElementById('quickHospitalAddress').value.trim(),
                hospitalPhone: document.getElementById('quickHospitalPhone').value.trim(),
                hospitalEmail: document.getElementById('quickHospitalEmail').value.trim(),
                logo1Url: document.getElementById('quickLogo1Url').value.trim(),
                logo2Url: document.getElementById('quickLogo2Url').value.trim()
            };

            // Save configuration
            localStorage.setItem('pdfHeaderConfig', JSON.stringify(config));
            hideConfigMenu();
            showSuccessMessage('Konfigurasi PDF berhasil disimpan!');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('configDropdown');
            const button = document.getElementById('configMenuButton');
            
            if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // PDF Export Function
        async function exportToPDF(headerConfig = null) {
            if (!currentRoom || !currentDataType) return;

            // Use provided config or load from localStorage
            let config = headerConfig;
            if (!config) {
                const savedConfig = localStorage.getItem('pdfHeaderConfig');
                config = savedConfig ? JSON.parse(savedConfig) : {
                    hospitalName: 'RUMAH SAKIT UMUM DAERAH',
                    hospitalAddress: '',
                    hospitalPhone: '',
                    hospitalEmail: '',
                    logo1Url: '',
                    logo2Url: ''
                };
            }

            const { jsPDF } = window.jspdf;
            // F4 size: 210 x 330 mm
            // Start with landscape for page 1
            const pdf = new jsPDF('l', 'mm', [210, 330]);
            
            // Get current data
            const data = currentRoom.data[currentDataType] || [];
            const filteredData = data.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getMonth() === currentViewMonth && entryDate.getFullYear() === currentViewYear;
            });

            const monthNames = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];

            const dataTypeNames = {
                temperature: 'SUHU RUANGAN',
                humidity: 'KELEMBABAN',
                fridge: 'SUHU KULKAS'
            };

            // Function to load image and handle errors
            async function loadImage(url) {
                if (!url) return null;
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => resolve(img);
                    img.onerror = () => resolve(null);
                    img.src = url;
                });
            }

            // Load logos
            const logo1Image = await loadImage(config.logo1Url);
            const logo2Image = await loadImage(config.logo2Url);

            // Function to draw header for both pages
            function drawHeader(pdf, isLandscape = true) {
                const centerX = isLandscape ? 165 : 105;
                const maxWidth = isLandscape ? 330 : 210;
                
                pdf.setTextColor(0, 0, 0);
                pdf.setFont(undefined, 'bold');
                
                // Add Logo 1 (kiri atas)
                if (logo1Image) {
                    pdf.addImage(logo1Image, 'PNG', 15, 10, 20, 20);
                }
                
                // Add Logo 2 (kanan atas)
                if (logo2Image) {
                    const rightX = isLandscape ? 295 : 175;
                    pdf.addImage(logo2Image, 'PNG', rightX, 10, 20, 20);
                }

                // Hospital name - centered
                pdf.setFontSize(14);
                pdf.text(config.hospitalName, centerX, 18, { align: 'center' });
                
                let currentY = 25;
                
                // Address - centered if provided
                if (config.hospitalAddress) {
                    pdf.setFontSize(10);
                    pdf.text(config.hospitalAddress, centerX, currentY, { align: 'center' });
                    currentY += 6;
                }
                
                // Contact info - centered if provided
                const contactInfo = [];
                if (config.hospitalPhone) contactInfo.push(`Tel: ${config.hospitalPhone}`);
                if (config.hospitalEmail) contactInfo.push(`Email: ${config.hospitalEmail}`);
                
                if (contactInfo.length > 0) {
                    pdf.setFontSize(9);
                    pdf.text(contactInfo.join(' | '), centerX, currentY, { align: 'center' });
                    currentY += 8;
                }

                // Separator line
                const lineY = currentY + 2;
                pdf.setLineWidth(0.5);
                pdf.line(15, lineY, maxWidth - 15, lineY);
                
                // Main title - centered below separator
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text(`LEMBAR PEMANTAUAN ${dataTypeNames[currentDataType]}`, centerX, lineY + 10, { align: 'center' });
                
                // Room and period info - left aligned
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'normal');
                pdf.text(`Ruangan: ${currentRoom.name}`, 15, lineY + 22);
                pdf.text(`Periode: ${monthNames[currentViewMonth]} ${currentViewYear}`, 15, lineY + 30);
                
                return lineY + 40; // Return Y position for content
            }

            // Page 1: Header and Chart (Landscape F4)
            const contentStartY = drawHeader(pdf, true);

            // Capture chart - larger for landscape
            const chartCanvas = document.getElementById('detailChart');
            const chartImage = await html2canvas(chartCanvas, {
                backgroundColor: 'white',
                scale: 2
            });
            
            const chartImgData = chartImage.toDataURL('image/png');
            pdf.addImage(chartImgData, 'PNG', 20, contentStartY, 290, 120);

            // Page 2: Data Table (Portrait F4)
            pdf.addPage([210, 330], 'p');
            const tableStartY = drawHeader(pdf, false);

            // Data table
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('DATA TERCATAT', 105, tableStartY + 10, { align: 'center' });

            // Table headers
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'bold');
            const startY = tableStartY + 25;
            const rowHeight = 10;
            
            // Draw table header
            pdf.rect(15, startY, 180, rowHeight);
            pdf.text('Tanggal', 20, startY + 6);
            pdf.text('Shift', 70, startY + 6);
            pdf.text('Nilai', 105, startY + 6);
            pdf.text('Pengisi', 140, startY + 6);

            // Table data
            pdf.setFont(undefined, 'normal');
            let currentY = startY + rowHeight;
            
            filteredData.forEach((entry, index) => {
                if (currentY > 310) {
                    pdf.addPage([210, 330], 'p');
                    currentY = 20;
                }
                
                // Alternate row colors
                if (index % 2 === 0) {
                    pdf.setFillColor(248, 250, 252);
                    pdf.rect(15, currentY, 180, rowHeight, 'F');
                }
                
                pdf.rect(15, currentY, 180, rowHeight);
                pdf.text(entry.date, 20, currentY + 6);
                pdf.text(entry.shift.charAt(0).toUpperCase() + entry.shift.slice(1), 70, currentY + 6);
                pdf.text(entry.value.toString(), 105, currentY + 6);
                pdf.text(entry.operator, 140, currentY + 6);
                
                currentY += rowHeight;
            });

            // Add summary at the bottom
            currentY += 15;
            if (currentY > 310) {
                pdf.addPage([210, 330], 'p');
                currentY = 20;
            }
            
            pdf.setFont(undefined, 'bold');
            pdf.setFontSize(12);
            pdf.text('RINGKASAN:', 15, currentY);
            currentY += 10;
            
            pdf.setFont(undefined, 'normal');
            pdf.setFontSize(11);
            pdf.text(`Total data tercatat: ${filteredData.length}`, 15, currentY);
            currentY += 8;
            
            if (filteredData.length > 0) {
                const values = filteredData.map(d => d.value);
                const minValue = Math.min(...values);
                const maxValue = Math.max(...values);
                const avgValue = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
                
                pdf.text(`Nilai minimum: ${minValue}`, 15, currentY);
                currentY += 8;
                pdf.text(`Nilai maksimum: ${maxValue}`, 15, currentY);
                currentY += 8;
                pdf.text(`Nilai rata-rata: ${avgValue}`, 15, currentY);
            }

            // Save PDF
            const fileName = `Pemantauan_${dataTypeNames[currentDataType]}_${currentRoom.name}_${monthNames[currentViewMonth]}_${currentViewYear}.pdf`;
            pdf.save(fileName);
            
            showSuccessMessage('PDF berhasil diexport!');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98ee8af736584ac1',t:'MTc2MDUyMzE5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
